apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
  # Aggiungi un finalizer per permettere ad Argo CD di eliminare le risorse
  # in modo pulito quando questa Application viene cancellata.
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  
  # Sorgente: L'Helm Chart ufficiale di Nextcloud
  source:
    repoURL: https://nextcloud.github.io/helm/
    chart: nextcloud
    targetRevision: '8.5.1'  # Pinna sempre una versione specifica del chart!
    
    # Qui è dove configuri Nextcloud. 
    # Questi sono i 'values.yaml' che passi all'Helm chart.
    helm:
      values: |
        # --- Configurazione Generale di Nextcloud ---
        nextcloud:
          host: "nextcloud.tuodominio.com"  # <-- MODIFICA QUESTO
          username: "admin"
          password: "CAMBIAMI_PASSWORD_ADMIN" # <-- MODIFICA QUESTO

        # --- Configurazione Ingress (per k3s/Traefik) ---
        ingress:
          enabled: true
          className: "traefik" # k3s usa Traefik come predefinito
          annotations:
            # Abilita cert-manager per SSL automatico (presuppone tu abbia cert-manager installato)
            cert-manager.io/cluster-issuer: "letsencrypt-prod"
          tls:
            - secretName: nextcloud-tls
              hosts:
                - "nextcloud.tuodominio.com" # <-- MODIFICA QUESTO

        # --- Abilita e configura il Database interno (MariaDB) ---
        mariadb:
          enabled: true
          auth:
            rootPassword: "CAMBIAMI_PASSWORD_DB_ROOT" # <-- MODIFICA QUESTO
            password: "CAMBIAMI_PASSWORD_DB_NEXTCLOUD" # <-- MODIFICA QUESTO

        # --- Abilita e configura Redis interno (per caching e file locking) ---
        redis:
          enabled: true
          
        # --- Configurazione della Persistenza (Storage) ---
        persistence:
          enabled: true
          # NOTA: 'local-path' è il provisioner predefinito di k3s.
          # Funziona bene per un cluster single-node.
          # Vedi le avvertenze sotto se hai un cluster multi-nodo.
          storageClass: "local-path"
          size: 10Gi

        # Consigliato per migliorare le prestazioni e la gestione
        cronjob:
          enabled: true

        # Disabilita il LoadBalancer, useremo Ingress
        service:
          type: ClusterIP

  # Destinazione: Dove Argo CD deve installare Nextcloud
  destination:
    server: https://kubernetes.default.svc
    namespace: nextcloud # Crea un namespace dedicato per Nextcloud

  # Sync Policy: Come Argo CD deve gestire la sincronizzazione
  syncPolicy:
    automated:
      prune: true    # Rimuove le risorse che non sono più nel chart
      selfHeal: true # Si auto-corregge se la configurazione live devia
    syncOptions:
      - CreateNamespace=true # Dice ad Argo CD di creare il namespace 'nextcloud'