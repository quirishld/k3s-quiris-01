apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  # Il nome della tua applicazione in Argo CD
  name: seafile
  # Indica ad Argo CD di gestire le risorse in questo namespace
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
source:
    # L'URL del repository Helm di Seafile
    repoURL: https://haiwen.github.io/seafile-helm-chart/repo
    # Il nome del chart
    chart: seafile
    # Specifica una versione per installazioni stabili
    targetRevision: 2.5.4 # Puoi cambiare alla versione più recente

    helm:
      values: |
        # --- Configurazione Ingress (per NGINX) ---
        ingress:
          enabled: true
          className: "nginx"
          hosts:
            # Sostituisco il dominio, usa quello che preferisci
            - host: "seafile.agnenergia.com" # <-- MODIFICA SE NECESSARIO
          annotations:
            # Fondamentale per l'upload di file grandi!
            nginx.ingress.kubernetes.io/proxy-body-size: "1024m"
        
        # --- Disabilita i componenti interni ---
        mariadb:
          enabled: false
        elasticsearch:
          enabled: false # Funzione di ricerca (non necessaria per iniziare)
        redis:
          enabled: false # Seafile abilita memcached di default, che è sufficiente

        # --- Configurazione Database Esterno (PostgreSQL) ---
        externalDatabase:
          enabled: true
          type: postgresql
          host: "k3s-db" # Il tuo host (via /etc/hosts)
          
          # I nomi dei 3 DB che hai creato al Passo 1
          ccnetDbName: "seafile_ccnet_db"
          seafileDbName: "seafile_db"
          seahubDbName: "seafile_seahub_db"
          
          user: "seafileuser" # L'utente creato
          password: "Cerauncagnonenelbosco2025!" # <-- Inserisci la password

        # --- Configurazione Storage (NFS) ---
        persistence:
          storageClass: "nfs-client" # La tua StorageClass
          size: 50Gi 

        # --- Configurazione Amministratore Seafile ---
        # All'avvio, Seafile creerà questo utente
        seafile:
          adminUser: "admin@seafile.local" # <-- Puoi cambiarlo
          adminPassword: "PasswordAdminSeafile!" # <-- CAMBIA QUESTO

        # --- Importante per i permessi NFS ---
        # Molti chart usano UID/GID 1000 di default.
        securityContext:
          runAsUser: 1000
          fsGroup: 1000

  destination:
    server: https://kubernetes.default.svc
    namespace: seafile # Installiamo in un nuovo namespace

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true